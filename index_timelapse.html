<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Population Timelapse – Thessalia</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
  <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
  <style>
    body { margin: 0; padding: 0; }
    #map { position: absolute; top: 0; bottom: 0; width: 100%; }
    .legend-box {
      position: absolute; 
      bottom: 30px; 
      left: 10px;  
      background-color: white; 
      padding: 15px;
      font-family: Arial, sans-serif; 
      font-size: 13px;
      border-radius: 5px; 
      box-shadow: 0 0 5px rgba(0,0,0,0.3);
      z-index: 1; 
      resize: both; 
      overflow: auto; 
      min-width: 200px; 
      min-height: 250px;
      max-width: 600px; 
      max-height: 85vh; 
    }
    .legend-header-title { margin-bottom: 16px; padding-bottom: 12px; border-bottom: 2px solid #333; }
    .legend-map-title { font-size: 14px; font-weight: 700; color: #000; margin-bottom: 8px; line-height: 1.3; text-align: center; }
    .legend-author { font-size: 9px; color: #666; line-height: 1.3; text-align: left; }
    .legend-section-title { font-weight: bold; margin-top: 12px; margin-bottom: 8px; }
    #timeline {
      position: absolute; 
      bottom: 30px; 
      right: 10px;
      background: white; 
      padding: 12px 15px; 
      border-radius: 5px;
      font-family: Arial, sans-serif; 
      font-size: 13px;
      box-shadow: 0 0 5px rgba(0,0,0,0.3); 
      z-index: 2; 
      text-align: center;
    }
    #yearSlider, #speedSlider, #maxRadiusSlider, #opacitySlider { width: 180px; margin-top: 5px; }
    #playPauseBtn { margin-top: 8px; padding: 6px 12px; font-size: 13px; cursor: pointer; border-radius: 3px; border: 1px solid #ccc; background: #f5f5f5; }
    .control-label { font-size: 11px; color: #666; margin-top: 8px; }
    .control-value { font-weight: bold; color: #333; }
  </style>
</head>
<body>

<select id="styleSelector" style="position:absolute;top:10px;left:10px;z-index:3;padding:5px;border-radius:3px;">
  <option value="https://basemaps.cartocdn.com/gl/positron-gl-style/style.json">Light</option>
  <option value="https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json" selected>Dark</option>
</select>

<div id="legend" class="legend-box">
  <div class="legend-header-title">
    <div class="legend-map-title">THESSALIA POPULATION<br>1991 - 2021</div>
    <div class="legend-author">
      <strong>Data source:</strong> ELSTAT - Population 1991-2021<br>
      <strong>Produced by:</strong> NIKOLAOS DIMITROPOULOS<br>
      <strong>Student ID:</strong> rs20435<br>
      NTUA - School of Rural, Surveying & Geoinformatics Engineering
    </div>
  </div>
  <div class="legend-section-title">Population (Municipal)</div>
  <div class="legend-content">
    <svg id="legendSvg" style="display: block; margin: 0 auto;"></svg>
  </div>
  <hr style="border: none; border-top: 1px solid #eee; margin: 12px 0;">
  <div style="display: flex; align-items: center; margin-top: 8px;">
    <svg width="40" height="18" style="margin-right: 8px;"><line x1="0" y1="9" x2="40" y2="9" stroke="rgb(200, 200, 200)" stroke-width="1.5"/></svg>
    <div style="font-size: 12px;">Municipal boundaries</div>
  </div>
</div>

<div id="timeline">
  <strong id="yearLabel">Year: 1991</strong><br>
  <input type="range" min="0" max="3" value="0" id="yearSlider"><br>
  <button id="playPauseBtn">▶ Play</button><br>
  <div class="control-label">Speed (ms/frame):</div>
  <input type="range" min="200" max="2000" value="1000" step="100" id="speedSlider">
  <span class="control-value" id="speedLabel">1000</span> ms<br>
  <div class="control-label">Max Circle Radius (px):</div>
  <input type="range" min="40" max="150" value="100" id="maxRadiusSlider">
  <span class="control-value" id="maxRadiusValue">100</span> px<br>
  <div class="control-label">Opacity:</div>
  <input type="range" min="0" max="100" value="50" id="opacitySlider">
  <span class="control-value" id="opacityValue">50</span>%
</div>

<div id="map"></div>

<script>
  const YEAR_COLUMNS = ['POP1991', 'POP2001', 'POP2011', 'POP2021'];
  const YEARS = [1991, 2001, 2011, 2021];
  const DATA_PATH = 'data_timelapse/dimoi_poipop_timelapse_WGS.geojson';
  const BOUNDARIES_PATH = 'data_timelapse/dimoi_oria.geojson';

  let map = new maplibregl.Map({
    container: 'map',
    style: 'https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json',
    center: [22.4, 39.4], 
    zoom: 8.2
  });

  let geojsonData = null, boundariesData = null, minPopulation = 0, maxPopulation = 0;
  let intervalId = null, isPlaying = false, speed = 1000, maxRadius = 100, opacity = 0.5, currentYearIndex = 0;

  function loadData() {
    Promise.all([
      fetch(DATA_PATH).then(r => r.json()),
      fetch(BOUNDARIES_PATH).then(r => r.json())
    ]).then(([popData, boundData]) => {
      popData.features.sort((a, b) => (b.properties[YEAR_COLUMNS[0]] || 0) - (a.properties[YEAR_COLUMNS[0]] || 0));
      geojsonData = popData; boundariesData = boundData;
      calculatePopulationRange();
      addBoundariesLayer(); addPopulationLayer();
      updateVisibleYear(0); updateLegend();
    }).catch(err => console.error('Error:', err));
  }

  function calculatePopulationRange() {
    let vals = [];
    geojsonData.features.forEach(f => YEAR_COLUMNS.forEach(c => { if(f.properties[c]) vals.push(f.properties[c]); }));
    maxPopulation = Math.max(...vals);
  }

  function addBoundariesLayer() {
    map.addSource('boundaries-source', { type: 'geojson', data: boundariesData });
    map.addLayer({
      id: 'boundaries-layer', type: 'line', source: 'boundaries-source',
      paint: { 'line-color': 'rgb(200, 200, 200)', 'line-width': 1, 'line-opacity': 0.5 }
    });
  }

  function addPopulationLayer() {
    map.addSource('population-source', { type: 'geojson', data: geojsonData });
    map.addLayer({
      id: 'population-layer', type: 'circle', source: 'population-source',
      paint: { 'circle-color': 'red', 'circle-opacity': opacity, 'circle-radius': getFlanneryExpression(YEAR_COLUMNS[0]) }
    });
  }

  function getFlanneryExpression(col) {
    return ['*', ['^', ['/', ['get', col], maxPopulation], 0.57], maxRadius];
  }

  function updateVisibleYear(idx) {
    currentYearIndex = idx;
    map.setPaintProperty('population-layer', 'circle-radius', getFlanneryExpression(YEAR_COLUMNS[idx]));
    document.getElementById('yearLabel').innerText = 'Year: ' + YEARS[idx];
    document.getElementById('yearSlider').value = idx;
  }

  function updateLegend() {
    const v = [5000, 20000, 50000, 150000], labels = ["5.000", "20.000", "50.000", "150.000"];
    const r = v.map(val => Math.pow(val / maxPopulation, 0.57) * maxRadius);
    const svg = document.getElementById('legendSvg'), h = r[3]*2 + 30, w = r[3]*2 + 60, cx = w/2, base = h-10;
    svg.setAttribute('width', w); svg.setAttribute('height', h);
    let html = '';
    for(let i=3; i>=0; i--) {
      html += `<circle cx="${cx}" cy="${base-r[i]}" r="${r[i]}" fill="none" stroke="red" stroke-width="1.5"/>
               <text x="${cx}" y="${base-r[i]*2-5}" text-anchor="middle" font-size="10">${labels[i]}</text>`;
    }
    svg.innerHTML = html;
  }

  document.getElementById('yearSlider').addEventListener('input', e => updateVisibleYear(parseInt(e.target.value)));
  document.getElementById('speedSlider').addEventListener('input', e => {
    speed = parseInt(e.target.value); document.getElementById('speedLabel').innerText = speed;
    if(isPlaying) { clearInterval(intervalId); intervalId = setInterval(playNextFrame, speed); }
  });
  document.getElementById('maxRadiusSlider').addEventListener('input', e => {
    maxRadius = parseInt(e.target.value); document.getElementById('maxRadiusValue').innerText = maxRadius;
    updateVisibleYear(currentYearIndex); updateLegend();
  });
  document.getElementById('opacitySlider').addEventListener('input', e => {
    opacity = e.target.value/100; document.getElementById('opacityValue').innerText = e.target.value;
    map.setPaintProperty('population-layer', 'circle-opacity', opacity);
  });
  document.getElementById('playPauseBtn').addEventListener('click', () => {
    isPlaying = !isPlaying;
    document.getElementById('playPauseBtn').innerText = isPlaying ? '⏸ Pause' : '▶ Play';
    if(isPlaying) intervalId = setInterval(playNextFrame, speed); else clearInterval(intervalId);
  });
  function playNextFrame() { updateVisibleYear((currentYearIndex + 1) % YEARS.length); }
  
  document.getElementById('styleSelector').addEventListener('change', e => {
    map.setStyle(e.target.value);
    map.once('styledata', () => { addBoundariesLayer(); addPopulationLayer(); updateVisibleYear(currentYearIndex); });
  });

  map.on('load', loadData);
</script>
</body>
</html>



